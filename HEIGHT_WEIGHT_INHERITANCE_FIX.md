# 身長・体重の空データ保存問題の修正

## 修正日時
2025年11月3日

## 問題の説明

検診結果（眼科検診、耳鼻科検診、内科検診など）のみを入力して保存すると、身長・体重が空（NULL）のレコードが作成されていました。

### 例
松葉さんのレコード：
- レコード#998: 耳鼻科検診のみ → 身長・体重 = NULL
- レコード#997: 内科検診のみ → 身長・体重 = NULL
- レコード#994: 耳鼻科検診のみ → 身長・体重 = NULL

結果、詳細ページの「成長記録」グラフや「関連する測定記録」に空データが大量に表示されてしまう。

## 修正内容

`HealthRecordCreate.vue` の保存ロジックを修正し、**身長・体重が未入力の場合は、その生徒の最新レコードから値を自動的に引き継ぐ**ようにしました。

### 主な変更点

1. **最新レコードの取得**
   ```javascript
   // 既存レコードがない場合、同じ生徒の最新レコードを取得
   let latestRecord = existingRecord;
   if (!latestRecord && healthRecordStore.healthRecords && healthRecordStore.healthRecords.value) {
     const studentLatestRecords = healthRecordStore.healthRecords.value
       .filter(r => r.student_id === selectedStudent.value.student_id)
       .sort((a, b) => new Date(b.measured_date) - new Date(a.measured_date));
     if (studentLatestRecords.length > 0) {
       latestRecord = studentLatestRecords[0];
     }
   }
   ```

2. **身長・体重の引き継ぎ**
   ```javascript
   // 身長・体重：入力されていない場合は最新レコードから引き継ぐ
   height: measurementItems.height && form.height ? 
     parseFloat(form.height) : (latestRecord?.height || null),
   weight: measurementItems.weight && form.weight ? 
     parseFloat(form.weight) : (latestRecord?.weight || null),
   ```

3. **動作の説明**
   - 身長・体重の項目にチェックが入っていて、値が入力されている場合 → その値を使用
   - 身長・体重の項目にチェックが入っていない場合 → 最新レコードから引き継ぐ
   - 最新レコードも存在しない場合 → NULL（初回登録時）

## 使用例

### ケース1: 検診結果のみを入力（身長・体重は未入力）

**前提条件:**
- 松葉さんの最新レコード: 身長 155.0cm、体重 45.0kg

**操作:**
1. 健康記録作成ページで松葉さんを選択
2. 測定日: 2025-11-03
3. 測定項目: 身長・体重のチェックを**外す**
4. 検診項目: ✓ 内科検診
5. 検診結果: 喘息
6. 保存

**結果（修正後）:**
- 新しいレコードが作成される
- **身長: 155.0cm（最新レコードから引き継ぎ）**
- **体重: 45.0kg（最新レコードから引き継ぎ）**
- 内科検診結果: 喘息

**結果（修正前）:**
- 新しいレコードが作成される
- 身長: NULL（空）
- 体重: NULL（空）
- 内科検診結果: 喘息

### ケース2: 身長・体重と検診結果の両方を入力

**操作:**
1. 健康記録作成ページで松葉さんを選択
2. 測定日: 2025-11-03
3. 測定項目: ✓ 身長・体重
4. 身長: 156.5cm
5. 体重: 46.0kg
6. 検診項目: ✓ 耳鼻科検診
7. 耳鼻科検診データを入力
8. 保存

**結果:**
- 新しいレコードが作成される
- **身長: 156.5cm（入力された値）**
- **体重: 46.0kg（入力された値）**
- 耳鼻科検診結果: 入力されたデータ

### ケース3: 同じ日付のレコードが既に存在する場合

**前提条件:**
- 2025-11-03のレコードが既に存在（身長 155.0cm、体重 45.0kg、内科検診データあり）

**操作:**
1. 測定日: 2025-11-03（同じ日付）
2. 測定項目: 身長・体重のチェックを外す
3. 検診項目: ✓ 耳鼻科検診
4. 耳鼻科検診データを入力
5. 保存

**結果:**
- **既存レコードが更新される**（新しいレコードは作成されない）
- 身長: 155.0cm（既存のまま保持）
- 体重: 45.0kg（既存のまま保持）
- 内科検診結果: 既存のまま保持
- 耳鼻科検診結果: 新しいデータが追加

## メリット

1. **データの完全性**
   - 検診結果のみを入力しても、身長・体重データが保持される
   - 成長記録グラフに空データが表示されなくなる

2. **入力の簡便性**
   - 検診結果のみを記録したい場合、身長・体重を毎回入力する必要がない
   - 前回の値が自動的に引き継がれる

3. **グラフの正確性**
   - 成長記録グラフに不要な空データポイントが表示されない
   - 実際の測定データのみがプロットされる

## 技術詳細

### 実装箇所
`resources/js/views/health-records/HealthRecordCreate.vue` - Line 3807~3840

### ロジックフロー

```
1. フォーム送信
    ↓
2. 同じ測定日の既存レコードを検索
    ↓
3. 既存レコードがない？
    ├─ Yes → 同じ生徒の最新レコードを取得
    └─ No  → 既存レコードを使用
    ↓
4. recordDataを準備
    ├─ 身長チェック&入力あり？
    │   ├─ Yes → 入力値を使用
    │   └─ No  → 最新レコードから引き継ぎ
    ├─ 体重チェック&入力あり？
    │   ├─ Yes → 入力値を使用
    │   └─ No  → 最新レコードから引き継ぎ
    └─ 検診データ: 入力されたデータを使用
    ↓
5. レコード保存
    ├─ 既存レコードあり → 更新
    └─ 既存レコードなし → 新規作成
```

## 確認方法

1. ブラウザで **Ctrl+Shift+R** でキャッシュをクリア
2. 健康記録作成ページにアクセス
3. 生徒を選択
4. 測定項目の「身長・体重」のチェックを**外す**
5. 検診項目（例：内科検診）にチェックを入れる
6. 検診データを入力して保存
7. 詳細ページで身長・体重が前回の値から引き継がれていることを確認
8. 成長記録グラフに不要な空データが表示されないことを確認

## 注意事項

1. **初回登録時**
   - その生徒の過去のレコードが存在しない場合、身長・体重はNULLになります
   - 初回は必ず身長・体重を入力してください

2. **意図的に身長・体重を変更する場合**
   - 測定項目の「身長・体重」にチェックを入れる
   - 新しい値を入力する

3. **一括登録**
   - 一括登録では各生徒ごとに身長・体重を個別に入力する必要があります
   - 一括登録で身長・体重を未入力にすると、NULLで保存されます（修正は個別登録のみ）

## 既存の空データの対応

既存の空データレコード（身長・体重がNULL）については、以下の対応が考えられます：

### オプション1: 手動で削除
```sql
-- 身長・体重が空で、検診データのみのレコードを確認
SELECT id, student_id, measured_date, height, weight 
FROM health_records 
WHERE (height IS NULL OR height = 0) 
  AND (weight IS NULL OR weight = 0)
ORDER BY student_id, measured_date;

-- 必要に応じて削除（慎重に！）
-- DELETE FROM health_records WHERE id IN (994, 997, 998, ...);
```

### オプション2: 自動で最新値を設定
```sql
-- 各生徒の最新の有効な身長・体重を取得して設定
-- （SQLiteでは複雑なため、手動またはスクリプトで対応）
```

### オプション3: そのまま保持
- 修正後は新しい空データは作成されない
- 既存の空データは履歴として保持

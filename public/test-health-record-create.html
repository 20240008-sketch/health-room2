<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康記録作成テスト</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>健康記録作成テスト</h1>
    <p>このページで健康記録を作成し、<a href="/health-records" target="_blank">/health-records</a>で確認できます。</p>

    <form id="healthRecordForm">
        <div class="form-group">
            <label for="student_id">学生ID:</label>
            <input type="text" id="student_id" name="student_id" value="20230001" required>
        </div>

        <div class="form-group">
            <label for="year">年度:</label>
            <input type="number" id="year" name="year" value="2025" required>
        </div>

        <div class="form-group">
            <label for="measured_date">測定日:</label>
            <input type="date" id="measured_date" name="measured_date" value="2025-10-29" required>
        </div>

        <div class="form-group">
            <label for="height">身長 (cm):</label>
            <input type="number" id="height" name="height" step="0.1" placeholder="例: 165.5">
        </div>

        <div class="form-group">
            <label for="weight">体重 (kg):</label>
            <input type="number" id="weight" name="weight" step="0.1" placeholder="例: 58.2">
        </div>

        <div class="form-group">
            <label for="vision_right">視力（右）:</label>
            <select id="vision_right" name="vision_right">
                <option value="">選択してください</option>
                <option value="A">A (1.0以上)</option>
                <option value="B">B (0.9〜0.7)</option>
                <option value="C">C (0.6〜0.3)</option>
                <option value="D">D (0.3未満)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="vision_left">視力（左）:</label>
            <select id="vision_left" name="vision_left">
                <option value="">選択してください</option>
                <option value="A">A (1.0以上)</option>
                <option value="B">B (0.9〜0.7)</option>
                <option value="C">C (0.6〜0.3)</option>
                <option value="D">D (0.3未満)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="notes">備考:</label>
            <input type="text" id="notes" name="notes" placeholder="特記事項があれば入力してください">
        </div>

        <button type="submit">健康記録を保存</button>
    </form>

    <div id="result"></div>

    <script>
        document.getElementById('healthRecordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>送信中...</p>';
            
            const formData = new FormData(e.target);
            const data = {};
            
            formData.forEach((value, key) => {
                if (value) {
                    if (key === 'year') {
                        data[key] = parseInt(value);
                    } else if (key === 'height' || key === 'weight') {
                        data[key] = parseFloat(value);
                    } else {
                        data[key] = value;
                    }
                }
            });
            
            console.log('送信データ:', data);
            
            try {
                const response = await fetch('/api/v1/health-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('レスポンス:', result);
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>✓ 保存成功！</h3>
                        <p>ID: ${result.data.id}</p>
                        <p>学生: ${result.data.student.name}</p>
                        <p>年度: ${result.data.year}</p>
                        <p>身長: ${result.data.height || '未入力'} cm</p>
                        <p>体重: ${result.data.weight || '未入力'} kg</p>
                        <p>BMI: ${result.data.bmi || '計算不可'}</p>
                        <p><a href="/health-records" target="_blank">健康記録一覧を見る</a></p>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>✗ エラー</h3>
                        <p>${result.message}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('エラー:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>✗ エラー</h3>
                    <p>${error.message}</p>
                `;
            }
        });
    </script>
</body>
</html>

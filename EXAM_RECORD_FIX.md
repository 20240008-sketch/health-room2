# 複数検診結果の保存に関する修正

## 問題の説明

以前は、同じ生徒に対して複数の検診（例：内科検診、耳鼻科検診、内科検診）を入力すると、**毎回新しいレコードが作成されてしまう**問題がありました。

### 例
1. 内科検診を入力 → レコード995作成（内科検診データのみ）
2. 耳鼻科検診を入力 → レコード996作成（耳鼻科検診データのみ）
3. 内科検診を再度入力 → レコード997作成（内科検診データのみ）

結果：詳細ページでは**最後に入力した検診データのみ**が表示される

## 修正内容

`HealthRecordCreate.vue` の `handleSubmit` 関数を修正し、**既存レコードの検索と更新**機能を実装しました。

### 主な変更点

1. **既存レコードの検索**
   - 保存前に、同じ生徒・同じ年度・同じ測定日のレコードを検索
   - 見つかった場合は更新、見つからない場合は新規作成

2. **日付の正規化**
   - データベースの日付形式 `2025-11-03 00:00:00`
   - フォームの日付形式 `2025-11-03`
   - 日付部分のみを比較するように修正

3. **データの保持**
   - 更新時、チェックされていない検診項目は既存データを保持
   - チェックされた検診項目のみ新しいデータで更新

## 使用方法

### 同じレコードに複数の検診を追加する場合

**重要：同じ測定日を選択してください！**

#### 例：2025年11月3日に複数の検診を記録

1. **内科検診を入力**
   - 生徒を選択：松葉　千幸
   - 年度：2025
   - 測定日：**2025-11-03**
   - 検診項目：✓ 内科検診
   - 検診結果：喘息
   - 診断結果：喘息
   - → 「記録を作成」ボタンをクリック
   - → **新しいレコードが作成されます**

2. **耳鼻科検診を追加**
   - 生徒を選択：松葉　千幸
   - 年度：2025
   - 測定日：**2025-11-03**（同じ日付！）
   - 検診項目：✓ 耳鼻科検診
   - カテゴリ：耳
   - 検診結果：外耳炎
   - → 「記録を作成」ボタンをクリック
   - → **既存レコードが更新されます**（内科検診データは保持）

3. **眼科検診を追加**
   - 生徒を選択：松葉　千幸
   - 年度：2025
   - 測定日：**2025-11-03**（同じ日付！）
   - 検診項目：✓ 眼科検診
   - 検診結果：正常
   - → 「記録を作成」ボタンをクリック
   - → **既存レコードが更新されます**（内科検診・耳鼻科検診データは保持）

### 結果

詳細ページでは、**すべての検診結果**が表示されます：
- ✓ 内科検診：喘息
- ✓ 耳鼻科検診：外耳炎（耳）
- ✓ 眼科検診：正常

## 注意事項

1. **必ず同じ測定日を選択してください**
   - 測定日が異なると、新しいレコードが作成されます
   
2. **既存のデータは上書きされます**
   - 例：内科検診を2回入力した場合、2回目のデータで上書きされます
   
3. **通知メッセージの確認**
   - 新規作成：「記録作成完了」
   - 更新：「記録更新完了」

## テスト手順

1. ブラウザのキャッシュをクリア（Ctrl+Shift+R または Cmd+Shift+R）
2. 健康記録作成ページにアクセス
3. 上記の手順で複数の検診を入力
4. 詳細ページで全ての検診結果が表示されることを確認

## 技術詳細

### コードの変更箇所

`resources/js/views/health-records/HealthRecordCreate.vue` - Line 3770~3940

```javascript
// 既存レコードの検索
await healthRecordStore.fetchHealthRecords({
  student_id: selectedStudent.value.student_id,
  year: parseInt(form.academic_year)
});

// 日付の正規化比較
const recordDate = record.measured_date ? record.measured_date.split(' ')[0] : '';
const formDate = form.measured_date;

// 既存レコードがある場合は更新
if (existingRecord) {
  savedRecord = await healthRecordStore.updateHealthRecord(existingRecord.id, mergedData);
} else {
  savedRecord = await healthRecordStore.createHealthRecord(recordData);
}
```

### データベース構造

- `health_records` テーブル
  - `student_id`: 生徒ID
  - `year`: 年度
  - `measured_date`: 測定日
  - `ophthalmology_exam_result`: 眼科検診結果
  - `otolaryngology_result`: 耳鼻科検診結果（JSON）
  - `internal_medicine_result`: 内科検診結果（JSON）
  - `hearing_test_result`: 聴力検査結果（JSON）
  - `tuberculosis_test_result`: 結核検査結果（JSON）
  - `urine_test_result`: 尿検査結果（JSON）
  - `ecg_result`: 心電図結果（JSON）

## 修正日時

2025年11月3日

## 追加修正：検診結果の表示順序

### 変更内容
詳細ページ（HealthRecordShow.vue）で、検診結果の表示順序を変更しました。

### 表示順序（上から下）
1. **内科検診**
2. **耳鼻科検診**
3. **眼科検診**
4. 聴力検査
5. 結核検査
6. 尿検査
7. 心電図

この順序により、最後に追加した検診（内科検診など）が上部に表示され、より見やすくなります。

### 表示例

```
検査結果
┌─────────────────────┐
│ 内科検診            │ ← 最後に追加
│ 検診結果: 喘息      │
│ 診断結果: 喘息      │
└─────────────────────┘

┌─────────────────────┐
│ 耳鼻科検診          │ ← 2番目に追加
│ 分類: 鼻            │
│ 検診結果: アレルギー性鼻炎 │
└─────────────────────┘

┌─────────────────────┐
│ 眼科検診            │ ← 最初に追加
│ 検診結果: 正常      │
└─────────────────────┘
```

すべての検診結果が縦に連なって表示されます。
